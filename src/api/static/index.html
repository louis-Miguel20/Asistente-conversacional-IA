<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Conversacional IA</title>
    <link rel="icon" type="image/svg+xml" href="static/favicon.svg">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="brand">
                <!-- Asegúrate de que finanzauto.png esté en src/api/static/ -->
                <img src="static/finanzauto.png" alt="Finanzauto Logo" class="logo" onerror="this.style.display='none'">
                <div>
                    <h1>Asistente Inteligente</h1>
                    <span class="status" id="status-text">Conectando...</span>
                </div>
            </div>
            <div class="upload-area">
                <input type="file" id="file-input" accept=".pdf,.txt" style="display: none">
                <button onclick="document.getElementById('file-input').click()" id="upload-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    Subir Documento
                </button>
            </div>
        </header>

        <div id="chat-history">
            <div class="message ai">
                ¡Hola! Soy tu asistente virtual de Finanzauto. Por favor sube un documento (PDF o TXT) para que pueda ayudarte a responder tus dudas sobre él.
            </div>
        </div>

        <footer>
            <form id="chat-form">
                <input type="text" id="question-input" placeholder="Escribe tu pregunta aquí..." autocomplete="off">
                <button type="submit">
                    <span>Enviar</span>
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </form>
        </footer>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const chatHistory = document.getElementById('chat-history');
        const form = document.getElementById('chat-form');
        const questionInput = document.getElementById('question-input');
        const fileInput = document.getElementById('file-input');
        const statusText = document.getElementById('status-text');

        let currentFilename = null;

        // Check health
        fetch(`${API_BASE}/health`)
            .then(res => res.json())
            .then(() => statusText.textContent = "Sistema Online ✅")
            .catch(() => statusText.textContent = "Sistema Offline ❌");

        // Handle file upload
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const btn = document.getElementById('upload-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = "Subiendo...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!res.ok) throw new Error('Error al subir');
                
                const data = await res.json();
                addMessage(`✅ Archivo cargado exitosamente: <strong>${file.name}</strong>`, 'ai');
                statusText.textContent = `Documento activo: ${file.name}`;
                currentFilename = file.name; // Guardar el nombre del archivo actual
            } catch (err) {
                addMessage(`❌ Error al subir archivo: ${err.message}`, 'ai');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                fileInput.value = '';
            }
        });

        // Handle chat
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = questionInput.value.trim();
            if (!question) return;

            addMessage(question, 'user');
            questionInput.value = '';
            
            // Show loading
            const loadingEl = addMessage('Analizando...', 'ai');

            try {
                const res = await fetch(`${API_BASE}/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question,
                        filename: currentFilename // Enviar filename actual (o null)
                    })
                });

                const data = await res.json();
                
                // Remove loading message
                if (loadingEl) loadingEl.remove();

                if (!res.ok) {
                    addMessage(`⚠️ Error: ${data.detail || 'Ocurrió un error inesperado'}`, 'ai');
                } else {
                    addMessage(data.answer, 'ai', data.context);
                }

            } catch (err) {
                if (loadingEl) loadingEl.remove();
                addMessage(`Error de conexión: ${err.message}`, 'ai');
            }
        });

        function addMessage(text, role, context = null) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            // Convert simple markdown bold to html
            let htmlContent = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Convert newlines to breaks
            htmlContent = htmlContent.replace(/\n/g, '<br>');
            div.innerHTML = htmlContent;

            if (context && context.length > 0) {
                const detailsId = `ctx-${Date.now()}-${Math.random()}`; // Unique ID for context toggle
                const toggle = document.createElement('div');
                toggle.className = 'context-toggle';
                toggle.innerHTML = `
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    Ver fuentes y contexto
                `;
                toggle.onclick = () => {
                    const box = document.getElementById(detailsId);
                    const isHidden = box.style.display === 'none';
                    box.style.display = isHidden ? 'block' : 'none';
                    toggle.querySelector('svg').style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                };
                
                const ctxBox = document.createElement('div');
                ctxBox.id = detailsId;
                ctxBox.className = 'context-box';
                ctxBox.style.display = 'none';
                ctxBox.innerHTML = context.map((c, i) => `
                    <div style="margin-bottom: 0.75rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
                        <strong style="color: #2563eb;">Fragmento ${i+1}:</strong>
                        <div style="margin-top: 0.25rem;">${c}</div>
                    </div>
                `).join('');
                
                div.appendChild(toggle);
                div.appendChild(ctxBox);
            }

            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return div; // Return the element itself
        }
    </script>
</body>
</html>
